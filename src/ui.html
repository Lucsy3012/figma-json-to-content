<body>

    <!-- Loading content -->
    <div class="container" id="main">
        <div class="loading-panel">
            <input id="data" placeholder="https://path.com/to/data.json" />
            <button id="load">Load</button>

            <!-- File upload -->
            <input id="fileupload" type="file" accept="application/json">
        </div>
        <p class="introduction-text" id="intro">Overwrite multiple text layers with real and coherent, yet randomized data. Simply load your JSON to set up some content. Then select a group or a frame and click “Fill with data”. The generator will pick a random entry but keeps the set together.</p>
        <p class="msg error" id="error-msg"></p>
    </div>

    <!-- All entries -->
    <ul id="entries"></ul>

    <!-- Footer -->
    <div class="container-s action-panel">
        <button id="fill" class="primary" disabled>Fill with random entry</button>
        <button id="close">Close</button>
    </div>
</body>

<style>
    :root {
        --font-family: 'Inter UI', sans-serif;
        --font-size: 11px;
        --line-height: 1.7;
        --easing: cubic-bezier(0.65, 0.29, 0.41, 1.07);

        --white: #fff;
        --light-gray: #f1f1f1;
        --border-gray: #cdcdcd;
        --black: #000;
    }
    .primary {
        --accent-color: #282c84;
        --accent-color-hover: #0b107e;
        --accent-color-light: rgba(40, 44, 132, 0.75);
        --accent-color-fade: rgba(40, 44, 132, 0.1);
        --button-color-text: #fff;
    }
    .error {
        --accent-color: #bb1919;
        --accent-color-hover: #911717;
        --accent-color-light: rgba(187, 25, 25, 0.75);
        --accent-color-fade: rgba(187, 25, 25, 0.15);
        --button-color-text: #fff;
    }

    * {
        font-family: 'Inter UI', sans-serif;
        box-sizing: border-box;
    }
    body {
        font-weight: 500;
        font-size: 12px;
        line-height: 1.7;
        letter-spacing: -0.02em;
        color: #000;
        margin: 0;
        padding-bottom: 56px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: geometricPrecision;
    }
    .container {
        padding: 20px;
    }
    .container-s {
        padding: 15px 20px;
    }
    p {
        color: rgba(0,0,0,0.5);
    }
    p:empty,
    ul:empty {
        display: none;
    }
    input, button {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        transition: all .2s var(--easing, cubic-bezier(0.65, 0.29, 0.41, 1.07));
    }

    input {
        outline: none;
        box-shadow: none;
        font-size: 12px;
        font-weight: 500;
        border: 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
        margin-right: 20px;
        padding: 4px 0;
    }
    a {
        color: var(--accent-color);
    }

    /* Regular Button */
    button {
        display: inline-block;
        padding: 4px 11px;
        font-size: 11px;
        font-weight: 500;
        color: var(--button-color-text, #000);
        background-color: var(--accent-color, #fff);
        border: 1px solid var(--accent-color, var(--border-gray, #cdcdcd));
        border-radius: 4px;
        cursor: pointer;
        letter-spacing: normal;
    }
    button:hover {
        color: var(--button-color-text, #fff);
        background-color: var(--accent-color-hover, #000);
        border-color: var(--accent-color-hover, #000);
    }
    button:disabled {
        color: rgba(97, 97, 97, 0.51);
        background-color: #dbdbdb;
        border-color: #dbdbdb;
    }

    /* Loading Panel */
    .loading-panel {
        align-items: center;
        display: flex;
        flex-wrap: wrap;
    }
    .loading-panel input {
        flex: auto;
    }
    .loading-panel button#load {
        margin-left: auto;
    }

    /* Action Panel */
    .action-panel {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        background-color: var(--light-gray);
        border-top: 1px solid var(--border-gray);
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
    }
    .action-panel button#close {
        margin-left: auto;
    }

    /* Entries List */
    ul#entries {
        margin: 0;
        padding: 0;
        display: none;
    }

    ul#entries li {
        display: block;
        background-color: var(--white, #fff);
    }

    ul#entries li * {
        pointer-events: none;
    }

    ul#entries li > .main {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        padding: 8px 20px;
        user-select: none;
        -webkit-user-select: none;
    }

    ul#entries li .index {
        display: inline-block;
        width: 28px;
        color: rgba(0,0,0,0.5);
    }

    ul#entries li .name {
        display: inline-block;
        width: calc(100% - 28px);
        padding-right: 16px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        font-size: 13px;
        font-weight: 600;
        letter-spacing: -0.02em;
    }

    ul#entries li .arrow {
        display: none;
        position: absolute;
        right: 15px;
        padding: 3px 8px;
        font-size: 8px;
        text-align: center;
        color: rgba(0,0,0,0.33);
        transform: scaleY(-1);
        -webkit-transform: scaleY(-1);
        pointer-events: initial;
        cursor: pointer;
    }

    ul#entries li .arrow.opened {
        transform: scaleY(1);
        -webkit-transform: scaleY(1);
    }

    ul#entries li:nth-child(odd) {
        background-color: #f6f6f6;
    }

    ul#entries li [id^="more-information"] {
        display: none;
    }

    ul#entries li:hover {
        background-color: #e6e6e6;
        cursor: pointer;
    }

    ul#entries li:hover .arrow {
        display: inline-block;
    }

    ul#entries li dl {
        display: -ms-grid;
        display: grid;
        grid-template-columns: 90px auto;
        grid-column-gap: 10px;
        grid-row-gap: 4px;
        padding: 10px 0 14px;
        margin: 0 20px;
        color: rgba(0,0,0,0.75);
        border-top: 1px dotted rgba(0,0,0,0.25);
    }

    ul#entries li dl dt {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    ul#entries li dl dd {
        margin: 0;
    }

    /* Messages */
    .msg {
        margin: 18px 0 0;
        padding: 6px 14px;
        border-radius: 4px;
        color: var(--accent-color, #000);
        background: var(--accent-color-fade, rgba(0,0,0,0.1));
    }

    .msg ul {
        margin: 5px 0;
        padding: 0 0 0 18px;
        color: var(--accent-color-light, rgba(0,0,0,0.75));
    }
</style>

<script>

    document.getElementById('fileupload').onchange = () => {
        const element = document.getElementById('fileupload');
        const files = element.files;

        if (files.length <= 0) {
            return false;
        }

        var fr = new FileReader();

        fr.onload = function (e) {
            try {
                const data = JSON.parse(e.target.result);
                console.log('test: ', data);

                acceptAndSendData(parent, data);
            } catch(error) {
                console.log(error);
            }
        };

        fr.readAsText(files.item(0));
    };

    // Direct interactions
    document.getElementById('load').onclick = () => {
        const element = document.getElementById('data');
        const url = element.value;

        fetch(url)
            .then(response => {
                return response.json();
            })
            .then(data => {

                // if no access
                if (data.success === false) {
                    document.getElementById('error-msg').innerHTML = 'You have no permission to fetch this data. Please provide an URL that\'s publicly available.';
                } else {
                    acceptAndSendData(parent, data);
                }
            })
            .catch(error => {
                document.getElementById('error-msg').innerHTML = 'The file could not be loaded. Please check the following steps:<ul><li>Check if the URL is correct and complete.</li><li>Check if the URL is publicly available (local files will not work).</li><li>Check if the URL provides a valid JSON file (see <a href="https://raw.githubusercontent.com/Lucsy3012/figma-json-to-content/master/example/breaking-bad-season-one.json" target="_blank" rel="nofollow">example</a>).</li></ul>';
            });
    };

    document.getElementById('close').onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'close' } }, '*')
    };

    document.getElementById('fill').onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'fill' } }, '*')
    };

    // get specific entry
    document.getElementById('entries').addEventListener('click', function(e) {
        if (e.target.matches('li.data-entry')) {

            // get correct entry by comparing indexes
            let index = e.target.attributes.index.textContent;

            // fill in entry
            parent.postMessage({ pluginMessage: { type: 'fill-specific', index } }, '*')
        }
    });

    // open more information accordion of specific entry
    document.getElementById('entries').addEventListener('click', function(e) {
        if (e.target.matches('.arrow')) {
            toggleMoreInformation(e.target, e.target.attributes.index.textContent);
        }
    });

    function acceptAndSendData(parent, data) {

        // post data to ui
        parent.postMessage({ pluginMessage: { type: 'load', data } }, '*');

        // remove all entries from list
        document.getElementById('entries').innerHTML = '';

        // creates for each entry a direct link in list
        createEntries(parent, data);

        // initiate action
        document.getElementById('entries').style.display = 'block';
        document.getElementById('intro').style.display = 'none';
        document.getElementById('fill').disabled = false;
        document.getElementById('error-msg').innerHTML = '';

        // post message to figma
        parent.postMessage({ pluginMessage: { type: 'success', data } }, '*');
    }

    function createEntries(parent, data) {
        let i = 0;
        let errorCount = 0;

        // WARNING : if not an array, create an array
        if (data.length === undefined) {
            data = [data];
        }

        // iterate over data/json entries
        for (let entry of data) {

            // WARNING : if an object is empty
            let _errorEmpty = Object.keys(entry).length === 0;
            if (_errorEmpty && errorCount <= 0) {
                parent.postMessage({ pluginMessage: { type: 'warning', data: 'emptyObject' } }, '*');
                errorCount++;
            }

            if (!_errorEmpty) {

                // prepare dl
                let dl = document.createElement('dl');

                for (let value of Object.keys(entry)) {
                    let dt = document.createElement('dt');
                    let dd = document.createElement('dd');

                    dt.innerHTML = value + ':';
                    dt.title = value;
                    dl.appendChild(dt);

                    dd.innerHTML = entry[value];
                    dl.appendChild(dd);
                }

                // prepare li
                let name;
                let li = document.createElement('li');
                li.classList.add('data-entry');
                li.setAttribute('index', i);

                if (entry['Name']) {
                    name = entry['Name'];
                } else if (entry['name']) {
                    name = entry['name'];
                } else if (entry['Title']) {
                    name = entry['Title'];
                } else if (entry['title']) {
                    name = entry['title'];
                } else {
                    name = Object.values(entry)[0];
                }

                // create li
                li.innerHTML =
                    '<div class="main">' +
                    '<span class="index">' + (i + 1) + '.</span>' +
                        '<span class="name">' + name + '</span>' +
                        '<span class="arrow" index="' + i + '">▲</span>' +
                    '</div>' +
                    '<div id="more-information-' + i + '"></div>';

                // append li
                document.getElementById('entries').appendChild(li);
                document.getElementById('more-information-' + i).appendChild(dl);
                i++;
            }
        }
    }

    function toggleMoreInformation(el, index) {
        if (el.classList.contains('opened')) {
            document.getElementById('more-information-' + index).style.display = 'none';
            el.classList.remove('opened');
        } else {
            document.getElementById('more-information-' + index).style.display = 'block';
            el.classList.add('opened');
        }
    }

</script>